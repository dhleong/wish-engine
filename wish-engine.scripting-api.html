<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>wish-engine.scripting-api documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Wish-engine</span> <span class="project-version">0.1.0-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wish-engine</span></div></div></li><li class="depth-2 branch"><a href="wish-engine.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="wish-engine.edn.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>edn</span></div></a></li><li class="depth-2 branch"><a href="wish-engine.model.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>model</span></div></a></li><li class="depth-2 branch"><a href="wish-engine.runtime-eval.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>runtime-eval</span></div></a></li><li class="depth-2 branch current"><a href="wish-engine.scripting-api.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scripting-api</span></div></a></li><li class="depth-2"><a href="wish-engine.state.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>state</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="wish-engine.scripting-api.html#var-add-limited-use"><div class="inner"><span>add-limited-use</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-add-to-list"><div class="inner"><span>add-to-list</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-by-id"><div class="inner"><span>by-id</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-declare-class"><div class="inner"><span>declare-class</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-declare-effects"><div class="inner"><span>declare-effects</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-declare-features"><div class="inner"><span>declare-features</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-declare-items"><div class="inner"><span>declare-items</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-declare-list"><div class="inner"><span>declare-list</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-declare-options"><div class="inner"><span>declare-options</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-declare-race"><div class="inner"><span>declare-race</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-declare-subrace"><div class="inner"><span>declare-subrace</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-has.3F"><div class="inner"><span>has?</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-items-from-list"><div class="inner"><span>items-from-list</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-options-of"><div class="inner"><span>options-of</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-ordinal"><div class="inner"><span>ordinal</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-provide-attr"><div class="inner"><span>provide-attr</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-provide-feature"><div class="inner"><span>provide-feature</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-provide-features"><div class="inner"><span>provide-features</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-provide-limited-use"><div class="inner"><span>provide-limited-use</span></div></a></li><li class="depth-1"><a href="wish-engine.scripting-api.html#var-provide-to-list"><div class="inner"><span>provide-to-list</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">wish-engine.scripting-api</h1><div class="doc"><pre class="plaintext">Public scripting API

The public functions in this namespace (declared with `defn-api`) are
provided at runtime to wish-engine Data Source scripts. Data Source scripts
have two modes of operation: compile-time and runtime.

Compile-time, or "top-level," operation occurs when the Data Source is
initially loaded, and is used to declare all the primary entities that might
be used to build a character. As such, all compile-time functions are named
with the `declare-` prefix, such as [[declare-class]].  Compile-time
functions may *only* be used at compile-time.

Runtime operation occurs when a character sheet is in use, with the purpose
of building upon a primary entity (such as a Class) based on user-selected
options, in order to build up the "current" state of the entity. Runtime
functions are invoked on an entity state map, and return the new state,
allowing them to be used easily in pipelines to gradually add features, etc.

In general, any feature can have a runtime operation attached to it (also
known as an `on-provide` function, using the `:!` key) which will be applied
to an entity state when the feature is attached it. Such functions have a
simple signature:

```clojure
  (fn [state] state)
```

To simplify implementation, the `on-state` macro is provided, which
automatically threads the given `state` through. It might be used like:

```clojure
  (on-state
    (provide-feature :gunslinging)
    (provide-to-list :weapons :weapon/captains-pistol))
```

An extra value of having `state` provided at runtime to this function is
that you can access things like `:level` in order to dynamically change
the behavior of features, limited-uses, etc.---without requiring special
support from the sheet! For example:

```clojure
  (on-state
    (provide-limited-use
      {:id :gunslinging/precision-shot
       :uses (:level state)))
```

Note that the `on-state` macro provides the state with the implicit name
`state`, as in the signature described above.

In general, when providing things to an entity, whether features to an
entity, or items to a list, you can use:

  1. A function of `state` that returns the value: This enables you to
     refer to values that may be declared in other Data Sources, or which
     are dynamically added by other features at runtime. Several helpers for
     creating these functions exist, such as [options-of] or [items-from-list].
  2. A map: this represents an inline declaration of the feature at runtime,
     as you provide it. This is commonly used for class features that won't
     be referenced by other features.
  3. A keyword: this is syntactic sugar for using the [[by-id]] function,
     enabling you to easily reference a feature declared elsewhere.

In addition, for any `provide` or `declare` function that allows you to pass
multiple values, you can provide a mix of sequences and values, enabling you
to use strutures like `(map)` or list comprehension with `(for)` to generate
values.</pre></div><div class="public anchor" id="var-add-limited-use"><h3>add-limited-use</h3><div class="usage"><code>(add-limited-use state spec)</code></div><div class="doc"><pre class="plaintext">Legacy alias for `provide-limited-use`
</pre></div></div><div class="public anchor" id="var-add-to-list"><h3>add-to-list</h3><div class="usage"><code>(add-to-list state id-or-spec &amp; entries)</code></div><div class="doc"><pre class="plaintext">Legacy alias of `provide-to-list`
</pre></div></div><div class="public anchor" id="var-by-id"><h3>by-id</h3><div class="usage"><code>(by-id id)</code></div><div class="doc"><pre class="plaintext">Given an ID, returns a function of `state` that will fetch
the feature (or list item) with that ID</pre></div></div><div class="public anchor" id="var-declare-class"><h3>declare-class</h3><div class="usage"><code>(declare-class class-spec)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-declare-effects"><h3>declare-effects</h3><div class="usage"><code>(declare-effects &amp; effects)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-declare-features"><h3>declare-features</h3><div class="usage"><code>(declare-features &amp; features)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-declare-items"><h3>declare-items</h3><div class="usage"><code>(declare-items base &amp; items)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-declare-list"><h3>declare-list</h3><div class="usage"><code>(declare-list id-or-spec &amp; entries)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-declare-options"><h3>declare-options</h3><div class="usage"><code>(declare-options feature-id &amp; options)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-declare-race"><h3>declare-race</h3><div class="usage"><code>(declare-race race-spec)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-declare-subrace"><h3>declare-subrace</h3><div class="usage"><code>(declare-subrace parent-race-id race-spec)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-has.3F"><h3>has?</h3><div class="usage"><code>(has? vals-set coll)</code></div><div class="doc"><pre class="plaintext">Alias for (some) that can handle sets in production
</pre></div></div><div class="public anchor" id="var-items-from-list"><h3>items-from-list</h3><div class="usage"><code>(items-from-list list-id)</code></div><div class="doc"><pre class="plaintext">Given a list ID, returns a function of `state` that will fetch the items
from that list</pre></div></div><div class="public anchor" id="var-options-of"><h3>options-of</h3><div class="usage"><code>(options-of feature-id)</code></div><div class="doc"><pre class="plaintext">Given a feature ID, returns a function of `state` that fetches the
selected options of that feature</pre></div></div><div class="public anchor" id="var-ordinal"><h3>ordinal</h3><div class="usage"><code>(ordinal n)</code></div><div class="doc"><pre class="plaintext">Given an integer, returns the English ordinal string, EG: 1 -&gt; 1st, 2 -&gt;
2nd, etc.</pre></div></div><div class="public anchor" id="var-provide-attr"><h3>provide-attr</h3><div class="usage"><code>(provide-attr state attr-id-or-path value)</code></div><div class="doc"><pre class="plaintext">Provide an attribute to the entity, explictly. Attributes are used for
sheet-specific data, and can store permanent or temporary state. The path
can be a simple keyword or a sequence of keywords, and the value may be of
any type.

A common pattern for providing multiple values for an attribute is to share
a top-level key and store values in a sub-key based on the feature. For
example, an item with ID `:armor/browncoat` that provides a +2 bonus to AC
when equipped might look like:

```clojure
  {:id :armor/browncoat
   :name "An old coat from another time"
   :! (on-state
        (provide-attr [:buffs :ac :armor/browncoat] 2))}
```

Then in order to compute the total AC bonuses at runtime, client code can
do something like:

```clojure
  (-&gt;&gt; (get-in entity [:attrs :buffs :ac])
       vals
       (apply +))
```

This structure allows on-provide functions to provide attributes in
an idempotent way.

The ID of the feature that provided this attribute (IE :armor/browncoat
in the above example) will be stored at `[:attrs/meta ...path]`.</pre></div></div><div class="public anchor" id="var-provide-feature"><h3>provide-feature</h3><div class="usage"><code>(provide-feature state feature)</code></div><div class="doc"><pre class="plaintext">Provide a Feature to the entity. `feature` may be an ID keyword or a map,
declaring the feature inline. See [[declare-features]]</pre></div></div><div class="public anchor" id="var-provide-features"><h3>provide-features</h3><div class="usage"><code>(provide-features state &amp; features)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-provide-limited-use"><h3>provide-limited-use</h3><div class="usage"><code>(provide-limited-use state spec)</code></div><div class="doc"><pre class="plaintext">Provide a limited-use item, stored at `[:limited-uses id]` in the
entity. wish-engine does little with these directly, but as features
that may only be used a limited number of times are core to most
RPG systems, limited-use is a core function of wish.

Here's a real example from Wish:

```clojure
  (on-state
    (provide-limited-use
      {:id :sorcerer/points#uses
       :name "Sorcery Points"
       :uses (fn [#{level}] level)
       :restore-trigger (if (&lt; (:level state) 20)
                          :long-rest

                          ; NOTE: trigger on *both*; a long rest triggers
                          ; both, but if we don't declare both we will only
                          ; see :short-rest
                          #{:short-rest :long-rest})
       :restore-desc (when (= (:level state) 20)
                       "20 / Long Rest; 4 / Short Rest")
       :restore-amount
       (fn [#{trigger used level}]
         (if (= :short-rest trigger)
           (when (= 20 level) (min used 4))
           used))}))
```

Note the naming with the providing feature followed by the `#uses`
suffix. This is not required, but is a common convention. The entity
state will be passed to both the `:uses` and `:restore-amount` functions,
enabling you to scale uses programmatically. They may both alternatively
be declared statically. wish-engine will compile `:restore-amount` to a
function, and even provide a default value that restores everything, if
omitted.

Also note that, as elsewhere, the current state of the entity is available
as `state` (from the `on-state` macro), so we can access things like
`:level` in order to change the behavior at runtime.</pre></div></div><div class="public anchor" id="var-provide-to-list"><h3>provide-to-list</h3><div class="usage"><code>(provide-to-list state id-or-spec &amp; entries)</code></div><div class="doc"><pre class="plaintext">Provide one or more entries to a list. The list may either be declared by id or
with a list spec, which must be of the format:

```clojure
  {:id :my-list
   :type :up-to-you}
```

If the `:type` is `:feature`, each map item of `entries` will be treated
as [[provide-feature]].
</pre></div></div></div></body></html>